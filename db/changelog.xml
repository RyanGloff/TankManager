<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

<changeSet id="1" author="Ryan Gloff">
  <sql>
    CREATE SCHEMA tank_data_schema;
  </sql>
</changeSet>


<!-- Create tank table and sequence -->
<changeSet id="2" author="Ryan Gloff">
  <createTable tableName="tank" schemaName="tank_data_schema">
    <column name="id" type="BIGSERIAL">
      <constraints primaryKey="true" nullable="false"/>
    </column>
    <column name="name" type="VARCHAR(256)">
      <constraints nullable="false"/>
    </column>
    <column name="apex_host" type="VARCHAR(256)"/>
  </createTable>
</changeSet>

<!-- Create parameter table and sequence -->
<changeSet id="3" author="Ryan Gloff">
  <createTable tableName="parameter" schemaName="tank_data_schema">
    <column name="id" type="BIGSERIAL">
      <constraints primaryKey="true" nullable="false"/>
    </column>
    <column name="name" type="VARCHAR(64)">
      <constraints nullable="false"/>
    </column>
    <column name="apex_name" type="VARCHAR(64)"/>
  </createTable>
</changeSet>

<!-- Create parameter_reading table and sequence -->
<changeSet id="4" author="Ryan Gloff">
  <createTable tableName="parameter_reading" schemaName="tank_data_schema">
    <column name="id" type="BIGSERIAL">
      <constraints primaryKey="true" nullable="false"/>
    </column>
    <column name="tank_id" type="BIGINT">
      <constraints nullable="false"/>
    </column>
    <column name="parameter_id" type="BIGINT">
      <constraints nullable="false"/>
    </column>
    <column name="value" type="REAL">
      <constraints nullable="false"/>
    </column>
    <column name="time" type="TIMESTAMP WITH TIME ZONE">
      <constraints nullable="false"/>
    </column>
    <column name="show_in_dashboard" type="BOOLEAN" defaultValue="TRUE"/>
  </createTable>
</changeSet>

<changeSet id="5" author="Ryan Gloff">
  <addForeignKeyConstraint
    baseTableName="parameter_reading"
    baseColumnNames="tank_id"
    baseTableSchemaName="tank_data_schema"
    referencedTableName="tank"
    referencedColumnNames="id"
    referencedTableSchemaName="tank_data_schema"
    constraintName="parameter_reading_fkey_tank_id"
    schemaName="tank_data_schema"/>
  <addForeignKeyConstraint
    baseTableName="parameter_reading"
    baseColumnNames="parameter_id"
    baseTableSchemaName="tank_data_schema"
    referencedTableName="parameter"
    referencedColumnNames="id"
    referencedTableSchemaName="tank_data_schema"
    constraintName="parameter_reading_fkey_parameter_id"
    schemaName="tank_data_schema"/>
</changeSet>

<!-- Create alarm table and sequence -->
<changeSet id="6" author="Ryan Gloff">
  <createTable tableName="alarm" schemaName="tank_data_schema">
    <column name="id" type="BIGSERIAL">
      <constraints primaryKey="true" nullable="false"/>
    </column>
    <column name="name" type="VARCHAR(256)">
      <constraints nullable="false"/>
    </column>
    <column name="parameter_id" type="BIGINT">
      <constraints nullable="false"/>
    </column>
    <column name="tank_id" type="BIGINT">
      <constraints nullable="false"/>
    </column>
    <column name="high_limit" type="DOUBLE PRECISION"/>
    <column name="low_limit" type="DOUBLE PRECISION"/>
    <column name="severity" type="INTEGER" defaultValue="1"/>
  </createTable>
</changeSet>
<changeSet id="7" author="Ryan Gloff">
  <addForeignKeyConstraint
    baseTableName="alarm"
    baseColumnNames="parameter_id"
    baseTableSchemaName="tank_data_schema"
    referencedTableName="parameter"
    referencedColumnNames="id"
    referencedTableSchemaName="tank_data_schema"
    constraintName="alarm_fkey_parameter_id"
    schemaName="tank_data_schema"/>
  <addForeignKeyConstraint
    baseTableName="alarm"
    baseColumnNames="tank_id"
    baseTableSchemaName="tank_data_schema"
    referencedTableName="tank"
    referencedColumnNames="id"
    referencedTableSchemaName="tank_data_schema"
    constraintName="alarm_fkey_tank_id"
    schemaName="tank_data_schema"/>
</changeSet>

<!-- Create device_type table and sequence -->
<changeSet id="8" author="Ryan Gloff">
  <createTable tableName="device_type" schemaName="tank_data_schema">
    <column name="id" type="BIGSERIAL">
      <constraints primaryKey="true" nullable="false"/>
    </column>
    <column name="name" type="VARCHAR(256)">
      <constraints nullable="false"/>
    </column>
  </createTable>
</changeSet>

<!-- Create device table and sequence -->
<changeSet id="9" author="Ryan Gloff">
  <createTable tableName="device" schemaName="tank_data_schema">
    <column name="id" type="BIGSERIAL">
      <constraints primaryKey="true" nullable="false"/>
    </column>
    <column name="name" type="VARCHAR(256)">
      <constraints nullable="false"/>
    </column>
    <column name="host" type="VARCHAR(16)">
      <constraints nullable="false"/>
    </column>
    <column name="child_name" type="VARCHAR(256)"/>
    <column name="device_type_id" type="INTEGER">
      <constraints nullable="false"/>
    </column>
  </createTable>
</changeSet>
<changeSet id="10" author="Ryan Gloff">
  <addForeignKeyConstraint
    baseTableName="device"
    baseColumnNames="device_type_id"
    baseTableSchemaName="tank_data_schema"
    referencedTableName="device_type"
    referencedColumnNames="id"
    referencedTableSchemaName="tank_data_schema"
    constraintName="device_fkey_device_type_id"
    schemaName="tank_data_schema"/>
</changeSet>

<!-- Create device_power_target table and sequence -->
<changeSet id="11" author="Ryan Gloff">
  <createTable tableName="device_power_target" schemaName="tank_data_schema">
    <column name="id" type="BIGSERIAL">
      <constraints primaryKey="true" nullable="false"/>
    </column>
    <column name="device_id" type="INTEGER">
      <constraints nullable="false"/>
    </column>
    <column name="start_time" type="TIME WITHOUT TIME ZONE"/>
    <column name="end_time" type="TIME WITHOUT TIME ZONE"/>
    <column name="desired_power_state" type="BOOLEAN" defaultValue="TRUE"/>
    <column name="enforce_on_discrepancy" type="BOOLEAN" defaultValue="FALSE"/>
    <column name="notify_on_discrepancy" type="BOOLEAN" defaultValue="FALSE"/>
    <column name="min_acceptable_draw" type="INTEGER"/>
    <column name="max_acceptable_draw" type="INTEGER"/>
  </createTable>
</changeSet>
<changeSet id="12" author="Ryan Gloff">
  <addForeignKeyConstraint
    baseTableName="device_power_target"
    baseColumnNames="device_id"
    baseTableSchemaName="tank_data_schema"
    referencedTableName="device"
    referencedColumnNames="id"
    referencedTableSchemaName="tank_data_schema"
    constraintName="device_power_target_fkey_device_id"
    schemaName="tank_data_schema"/>
</changeSet>

<!-- Insert starting parameters -->
<changeSet id="13" author="Ryan Gloff">
  <insert tableName="parameter" schemaName="tank_data_schema">
    <column name="name" value="temperature"/>
    <column name="apex_name" value="temp"/>
  </insert>
  <insert tableName="parameter" schemaName="tank_data_schema">
    <column name="name" value="ph"/>
    <column name="apex_name" value="ph"/>
  </insert>
  <insert tableName="parameter" schemaName="tank_data_schema">
    <column name="name" value="alkalinity"/>
    <column name="apex_name" value="alk"/>
  </insert>
  <insert tableName="parameter" schemaName="tank_data_schema">
    <column name="name" value="calcium"/>
    <column name="apex_name" value="calc"/>
  </insert>
  <insert tableName="parameter" schemaName="tank_data_schema">
    <column name="name" value="magnesium"/>
    <column name="apex_name" value="mag"/>
  </insert>
  <insert tableName="parameter" schemaName="tank_data_schema">
    <column name="name" value="nitrate"/>
  </insert>
  <insert tableName="parameter" schemaName="tank_data_schema">
    <column name="name" value="phosphate"/>
  </insert>
  <insert tableName="parameter" schemaName="tank_data_schema">
    <column name="name" value="alkalinity-dosing"/>
  </insert>
  <insert tableName="parameter" schemaName="tank_data_schema">
    <column name="name" value="calcium-dosing"/>
  </insert>
  <insert tableName="parameter" schemaName="tank_data_schema">
    <column name="name" value="magnesium-dosing"/>
  </insert>
</changeSet>

<!-- Insert device_type HS300 -->
<changeSet id="14" author="Ryan Gloff">
  <insert tableName="device_type" schemaName="tank_data_schema">
    <column name="name" value="HS300"/>
  </insert>
</changeSet>

<!-- Remove Dosing Parameters -->
<changeSet id="15" author="Ryan Gloff">
  <delete tableName="device_type" schemaName="tank_data_schema">
    <where>name = 'alkalinity-dosing'</where>
  </delete>
  <delete tableName="device_type" schemaName="tank_data_schema">
    <where>name = 'calcium-dosing'</where>
  </delete>
  <delete tableName="device_type" schemaName="tank_data_schema">
    <where>name = 'magnesium-dosing'</where>
  </delete>
</changeSet>

<!-- Add table for parameter_goals -->
<changeSet id="16" author="Ryan Gloff">
  <createTable tableName="parameter_goal" schemaName="tank_data_schema">
    <column name="id" type="BIGSERIAL">
      <constraints primaryKey="true" nullable="false"/>
    </column>
    <column name="tank_id" type="BIGINT">
      <constraints nullable="false"/>
    </column>
    <column name="parameter_id" type="BIGINT">
      <constraints nullable="false"/>
    </column>
    <column name="low_limit" type="BIGINT">
      <constraints nullable="false"/>
    </column>
    <column name="high_limit" type="BIGINT">
      <constraints nullable="false"/>
    </column>
  </createTable>
</changeSet>
<changeSet id="17" author="Ryan Gloff">
  <addForeignKeyConstraint
    baseTableName="parameter_goal"
    baseColumnNames="tank_id"
    baseTableSchemaName="tank_data_schema"
    referencedTableName="tank"
    referencedColumnNames="id"
    referencedTableSchemaName="tank_data_schema"
    constraintName="parameter_goal_tank_id_fkey"
    schemaName="tank_data_schema"/>
  <addForeignKeyConstraint
    baseTableName="parameter_goal"
    baseColumnNames="parameter_id"
    baseTableSchemaName="tank_data_schema"
    referencedTableName="parameter"
    referencedColumnNames="id"
    referencedTableSchemaName="tank_data_schema"
    constraintName="parameter_goal_parameter_id_fkey"
    schemaName="tank_data_schema"/>
</changeSet>

<!-- Changing incorrect datatype of parameter_goal limits -->
<changeSet id="18" author="Ryan Gloff">
  <modifyDataType
    tableName="parameter_goal"
    schemaName="tank_data_schema"
    columnName="low_limit"
    newDataType="DOUBLE PRECISION"/>
  <modifyDataType
    tableName="parameter_goal"
    schemaName="tank_data_schema"
    columnName="high_limit"
    newDataType="DOUBLE PRECISION"/>
</changeSet>

<!-- Insert device_type HS300 -->
<changeSet id="19" author="Ryan Gloff">
  <insert tableName="parameter_goal" schemaName="tank_data_schema">
    <column name="tank_id" value="1"/>
    <column name="parameter_id" value="1"/>
    <column name="low_limit" value="77"/>
    <column name="high_limit" value="82"/>
  </insert>
  <insert tableName="parameter_goal" schemaName="tank_data_schema">
    <column name="tank_id" value="1"/>
    <column name="parameter_id" value="2"/>
    <column name="low_limit" value="8"/>
    <column name="high_limit" value="8.4"/>
  </insert>
  <insert tableName="parameter_goal" schemaName="tank_data_schema">
    <column name="tank_id" value="1"/>
    <column name="parameter_id" value="3"/>
    <column name="low_limit" value="9"/>
    <column name="high_limit" value="9.4"/>
  </insert>
  <insert tableName="parameter_goal" schemaName="tank_data_schema">
    <column name="tank_id" value="1"/>
    <column name="parameter_id" value="4"/>
    <column name="low_limit" value="480"/>
    <column name="high_limit" value="550"/>
  </insert>
  <insert tableName="parameter_goal" schemaName="tank_data_schema">
    <column name="tank_id" value="1"/>
    <column name="parameter_id" value="5"/>
    <column name="low_limit" value="1400"/>
    <column name="high_limit" value="1550"/>
  </insert>
  <insert tableName="parameter_goal" schemaName="tank_data_schema">
    <column name="tank_id" value="1"/>
    <column name="parameter_id" value="6"/>
    <column name="low_limit" value="0.5"/>
    <column name="high_limit" value="10"/>
  </insert>
  <insert tableName="parameter_goal" schemaName="tank_data_schema">
    <column name="tank_id" value="1"/>
    <column name="parameter_id" value="7"/>
    <column name="low_limit" value="0.3"/>
    <column name="high_limit" value="0.1"/>
  </insert>
</changeSet>

<!-- Remove Dosing Parameters -->
<changeSet id="20" author="Ryan Gloff">
  <delete tableName="parameter" schemaName="tank_data_schema">
    <where>name = 'alkalinity-dosing'</where>
  </delete>
  <delete tableName="parameter" schemaName="tank_data_schema">
    <where>name = 'calcium-dosing'</where>
  </delete>
  <delete tableName="parameter" schemaName="tank_data_schema">
    <where>name = 'magnesium-dosing'</where>
  </delete>
</changeSet>


</databaseChangeLog>

